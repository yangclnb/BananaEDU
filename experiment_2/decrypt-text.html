<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <title>è§£å¯†ä¿¡æ¯</title>
    <link rel="stylesheet" href="styles/main.css" />
  </head>

  <body>
    <nav>
      <a href="generate-keys.html">ç”Ÿæˆç§˜é’¥</a>
      <a href="encrypt-text.html">åŠ å¯†ä¿¡æ¯</a>
      <a class="selected" href="decrypt-text.html">è§£å¯†ä¿¡æ¯</a>
      <!-- <a href="encrypt-file.html">Encrypt File</a>
            <a href="decrypt-file.html">Decrypt File</a> -->
    </nav>

    <div class="page">
      <h1>ä½¿ç”¨ ç§é’¥ è§£å¯†æ•°æ® ğŸ”“</h1>
      <p class="header-description">
        å½“ä½ æ”¶åˆ°äº†ä¸€ä»½åŠ å¯†å†…å®¹ï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼ŒæŸ¥çœ‹æ˜æ–‡å†…å®¹
      </p>

      <div class="field">
        <label for="private-key">åœ¨ä¸‹æ–¹è¾“å…¥ä½ æ”¶åˆ°çš„ç§é’¥</label>
        <textarea id="private-key" rows="10"></textarea>
      </div>

      <div class="field">
        <label for="encrypted-text">åœ¨ä¸‹æ–¹è¾“å…¥ä½ æ”¶åˆ°çš„å¯†æ–‡</label>
        <textarea id="encrypted-text" rows="10"></textarea>
      </div>

      <button id="button">ç‚¹å‡»æŒ‰é’®è¿›è¡Œè§£å¯†ğŸ”‘</button>
      <div id="message"></div>

      <div id="result" class="field">
        <label for="decrypted-text">è§£å¯†ç»“æœ</label>
        <a id="decrypted-download" class="download" download="decrypted.txt"
          >ç‚¹å‡»ä¸‹è½½è§£å¯†åçš„å†…å®¹ decrypted.txt</a
        >
        <textarea id="decrypted-text" rows="10" readonly></textarea>
      </div>
    </div>

    <footer>
      <p>ä½›å†ˆå¿ä¿¡æ¯ç§‘æŠ€æ•™è‚²å¹³å°|ä½œè€…ï¼šæ¨æ™¨é¾™</p>
    </footer>
  </body>

  <script src="scripts/encoding-helper.js"></script>
  <script src="scripts/encryption-helper.js"></script>
  <script>
    (function () {
      var privateKey = document.getElementById("private-key");
      var encryptedText = document.getElementById("encrypted-text");
      var button = document.getElementById("button");
      var message = document.getElementById("message");
      var decryptedText = document.getElementById("decrypted-text");
      var decryptedDownload = document.getElementById("decrypted-download");
      var result = document.getElementById("result");

      var success = function (data) {
        decryptedText.value = new TextDecoder().decode(data);
        decryptedDownload.href = window.URL.createObjectURL(
          new Blob([decryptedText.value], { type: "text/plain" })
        );
        result.style.display = "block";
        message.innerText = null;
        button.disabled = false;
      };

      var error = function (error) {
        message.innerText = error;
        button.disabled = false;
      };

      var process = function () {
        message.innerText = "æ­£åœ¨è§£å¯†...";
        button.disabled = true;

        if (privateKey.value.trim() === "")
          return error("å¿…é¡»æä¾›ç§é’¥ï¼Œæ‰èƒ½è§£å¯†å“¦");

        var privateKeyArrayBuffer = null;
        try {
          privateKeyArrayBuffer = pemToArrayBuffer(privateKey.value.trim());
        } catch (_) {
          return error("è¿™ä¸ªç§é’¥æ— æ•ˆï¼Œæ£€æŸ¥çœ‹çœ‹æ˜¯ä¸æ˜¯æ¼äº†ä»€ä¹ˆ");
        }

        if (encryptedText.value.trim() === "")
          return error("å¿…é¡»æä¾›éœ€è¦è§£å¯†çš„å†…å®¹ï¼Œæ‰èƒ½æ‰èƒ½å“¦");

        var data = null;
        try {
          data = pemToArrayBuffer(encryptedText.value.trim());
        } catch (_) {
          return error("å¯†æ–‡æ— æ•ˆï¼Œæ£€æŸ¥çœ‹çœ‹æ˜¯ä¸æ˜¯æ¼äº†ä»€ä¹ˆ");
        }

        rsaDecrypt(data, privateKeyArrayBuffer).then(success, error);
      };

      button.addEventListener("click", process);
    })();
  </script>
</html>
